# ğŸ—ºï¸ Diagrama de Relaciones - Base de Datos PitaExpress

## ğŸ¯ Vista General de Conexiones

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AUTH LAYER                                â”‚
â”‚                   (Supabase Auth Schema)                        â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚          auth.users (Managed by Supabase)     â”‚              â”‚
â”‚  â”‚  - id (uuid, PK)                              â”‚              â”‚
â”‚  â”‚  - email, encrypted_password                  â”‚              â”‚
â”‚  â”‚  - raw_user_meta_data (jsonb)                 â”‚              â”‚
â”‚  â”‚    â†³ { full_name, avatar_url }                â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ id = user_id (FK)
                       â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                   â–¼                                   â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
   â”‚  â”‚      IDENTITY LAYER (RLS âœ…)             â”‚         â”‚
   â”‚  â”‚                                          â”‚         â”‚
   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚         â”‚
   â”‚  â”‚  â”‚  userlevel (Main Role Table)    â”‚     â”‚         â”‚
   â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚         â”‚
   â”‚  â”‚  â”‚  â”‚ id (uuid, PK = auth.id) â”‚   â”‚     â”‚         â”‚
   â”‚  â”‚  â”‚  â”‚ user_level: ENUM        â”‚   â”‚     â”‚         â”‚
   â”‚  â”‚  â”‚  â”‚  â”œâ”€ 'Admin'              â”‚   â”‚     â”‚         â”‚
   â”‚  â”‚  â”‚  â”‚  â”œâ”€ 'Client'             â”‚   â”‚     â”‚         â”‚
   â”‚  â”‚  â”‚  â”‚  â”œâ”€ 'China' (Employee)   â”‚   â”‚     â”‚         â”‚
   â”‚  â”‚  â”‚  â”‚  â”œâ”€ 'Vzla' (Employee)    â”‚   â”‚     â”‚         â”‚
   â”‚  â”‚  â”‚  â”‚  â””â”€ 'Pagos' (Employee)   â”‚   â”‚     â”‚         â”‚
   â”‚  â”‚  â”‚  â”‚ avatar_url (text)        â”‚   â”‚     â”‚         â”‚
   â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚         â”‚
   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚         â”‚
   â”‚  â”‚                   â”‚                       â”‚         â”‚
   â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚         â”‚
   â”‚  â”‚         â–¼                   â–¼             â”‚         â”‚
   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚         â”‚
   â”‚  â”‚  â”‚administratorsâ”‚    â”‚   clients    â”‚   â”‚         â”‚
   â”‚  â”‚  â”‚ (RLS âœ…)     â”‚    â”‚   (RLS âœ…)   â”‚   â”‚         â”‚
   â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚         â”‚
   â”‚  â”‚  â”‚ user_id (PK) â”‚    â”‚ user_id (PK) â”‚   â”‚         â”‚
   â”‚  â”‚  â”‚ name         â”‚    â”‚ name         â”‚   â”‚         â”‚
   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ email        â”‚   â”‚         â”‚
   â”‚  â”‚                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚         â”‚
   â”‚  â”‚                             â”‚            â”‚         â”‚
   â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
   â”‚  â”‚                    â”‚   employees     â”‚  â”‚         â”‚
   â”‚  â”‚                    â”‚   (RLS âœ…)      â”‚  â”‚         â”‚
   â”‚  â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚
   â”‚  â”‚                    â”‚ user_id (PK)    â”‚  â”‚         â”‚
   â”‚  â”‚                    â”‚ name            â”‚  â”‚         â”‚
   â”‚  â”‚                    â”‚ user_level      â”‚  â”‚         â”‚
   â”‚  â”‚                    â”‚ assigned_orders â”‚  â”‚         â”‚
   â”‚  â”‚                    â”‚ completed_ordersâ”‚  â”‚         â”‚
   â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚                     â”‚
                         â–¼                     â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  asignedEChina (FK) â”‚  â”‚  asignedEVzla (FK)  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                         â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                    ORDERS LAYER (RLS âŒ â†’ âœ…)                  â”‚
   â”‚                                                                 â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚  â”‚                    orders (Main Table)                    â”‚ â”‚
   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
   â”‚  â”‚  â”‚ id (bigint, PK, autoincrement)                     â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ created_at (timestamp)                             â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ client_id (uuid, FK â†’ clients.user_id) âœ…         â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ state (smallint, DEFAULT 1)                        â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â”œâ”€ -2: Rechazado                                 â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â”œâ”€ -1: Cancelado                                 â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â”œâ”€  1: Pedido creado                             â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â”œâ”€  2: Recibido                                  â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â”œâ”€  3: Cotizado                                  â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â”œâ”€  4: Esperando pago                            â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â”œâ”€  5: En procesamiento                          â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â”œâ”€  8: Enviado                                   â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â”œâ”€  9: En trÃ¡nsito                               â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â”œâ”€ 10: En aduana                                 â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â”œâ”€ 11: En almacÃ©n Venezuela                      â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â”œâ”€ 12: Listo para entrega                        â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚   â””â”€ 13: Entregado                                 â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ asignedEChina (uuid, FK â†’ employees) âœ…           â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ asignedEVzla (uuid, FK â†’ employees) âœ…            â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ batch_id (text, FK â†’ order_batches) âš ï¸            â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ productName, description, quantity                 â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ estimatedBudget, totalQuote, unitQuote             â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ imgs[] (text array), links[] (text array)          â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ pdfRoutes (text)                                   â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ shippingType, deliveryType (ENUMs)                 â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ height, width, long, weight (numeric)              â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ box_id (bigint, FK â†’ boxes) âœ…                     â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ archived_by_client, archived_by_admin (boolean)    â”‚  â”‚ â”‚
   â”‚  â”‚  â”‚ alternative_* (text) - Productos alternativos      â”‚  â”‚ â”‚
   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
   â”‚  â”‚                â”‚                                          â”‚ â”‚
   â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚ â”‚
   â”‚  â”‚   â”‚      TRIGGERS:          â”‚                           â”‚ â”‚
   â”‚  â”‚   â”‚  1. assign_order_on_insert (BEFORE INSERT)         â”‚ â”‚
   â”‚  â”‚   â”‚     â†’ assign_order_to_employee()                   â”‚ â”‚
   â”‚  â”‚   â”‚       Asigna a empleado menos ocupado              â”‚ â”‚
   â”‚  â”‚   â”‚  2. set_elapsed_time (BEFORE INSERT/UPDATE)        â”‚ â”‚
   â”‚  â”‚   â”‚     â†’ Calcula dÃ­as transcurridos                   â”‚ â”‚
   â”‚  â”‚   â”‚  3. tr_order_state_change (AFTER INSERT/UPDATE)    â”‚ â”‚
   â”‚  â”‚   â”‚     â†’ log_order_state_change()                     â”‚ â”‚
   â”‚  â”‚   â”‚       Registra en order_state_history              â”‚ â”‚
   â”‚  â”‚   â”‚  4. mandar-mensaje (AFTER UPDATE)                  â”‚ â”‚
   â”‚  â”‚   â”‚     â†’ Edge Function (notificaciones)               â”‚ â”‚
   â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚ â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â”‚                                                                 â”‚
   â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
   â”‚           â”‚                                 â”‚                  â”‚
   â”‚           â–¼                                 â–¼                  â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
   â”‚  â”‚ order_state_     â”‚         â”‚  product_alternatives    â”‚    â”‚
   â”‚  â”‚    history       â”‚         â”‚      (RLS âœ…)            â”‚    â”‚
   â”‚  â”‚  (RLS âŒ â†’ âœ…)   â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚ id (uuid, PK)            â”‚    â”‚
   â”‚  â”‚ order_id (FK)    â”‚         â”‚ order_id (FK â†’ orders)   â”‚    â”‚
   â”‚  â”‚ state (smallint) â”‚         â”‚ product_name             â”‚    â”‚
   â”‚  â”‚ previous_state   â”‚         â”‚ description              â”‚    â”‚
   â”‚  â”‚ timestamp        â”‚         â”‚ image_url                â”‚    â”‚
   â”‚  â”‚ changed_by       â”‚         â”‚ price_cny                â”‚    â”‚
   â”‚  â”‚ notes            â”‚         â”‚ status ('pending',       â”‚    â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚         'accepted',       â”‚    â”‚
   â”‚                               â”‚         'rejected')       â”‚    â”‚
   â”‚           â–¼                   â”‚ client_response_notes     â”‚    â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ created_at, updated_at   â”‚    â”‚
   â”‚  â”‚   payments       â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
   â”‚  â”‚  (RLS âŒ â†’ âœ…)   â”‚                                          â”‚
   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â–¼                     â”‚
   â”‚  â”‚ order_id (FK)    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
   â”‚  â”‚ payment_method   â”‚         â”‚   order_reviews          â”‚    â”‚
   â”‚  â”‚ amount_usd/bs    â”‚         â”‚      (RLS âœ…)            â”‚    â”‚
   â”‚  â”‚ status           â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
   â”‚  â”‚ reference        â”‚         â”‚ id (uuid, PK)            â”‚    â”‚
   â”‚  â”‚ verified_by      â”‚         â”‚ order_id (FK â†’ orders)   â”‚    â”‚
   â”‚  â”‚ verified_at      â”‚         â”‚ client_id (FK)           â”‚    â”‚
   â”‚  â”‚ img_url          â”‚         â”‚ rating (1-5)             â”‚    â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ review_text              â”‚    â”‚
   â”‚                               â”‚ created_at               â”‚    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜


   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚              LOGISTICS LAYER (RLS âŒ)                           â”‚
   â”‚                                                                 â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚  containers  â”‚      â”‚    boxes     â”‚      â”‚   orders    â”‚  â”‚
   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚   (ref)     â”‚  â”‚
   â”‚  â”‚container_id  â”‚â—„â”€â”€â”€â”€â”€â”‚container_id  â”‚      â”‚             â”‚  â”‚
   â”‚  â”‚  (PK)        â”‚  FK  â”‚  box_id (PK) â”‚â—„â”€â”€â”€â”€â”€â”‚  box_id     â”‚  â”‚
   â”‚  â”‚              â”‚      â”‚              â”‚  FK  â”‚             â”‚  â”‚
   â”‚  â”‚ state        â”‚      â”‚ state        â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚  â”‚ name         â”‚      â”‚ name         â”‚                        â”‚
   â”‚  â”‚ tracking_*   â”‚      â”‚ creation_dateâ”‚                        â”‚
   â”‚  â”‚ arrive_date  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
   â”‚                                                                 â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
   â”‚  â”‚ air_shipments    â”‚        â”‚ maritime_shipments   â”‚         â”‚
   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
   â”‚  â”‚ order_id (FK)    â”‚        â”‚ order_id (FK)        â”‚         â”‚
   â”‚  â”‚ awb_number       â”‚        â”‚ vessel_name[]        â”‚         â”‚
   â”‚  â”‚ airline_code[]   â”‚        â”‚ container_id[]       â”‚         â”‚
   â”‚  â”‚ flight_number[]  â”‚        â”‚ voyage_number        â”‚         â”‚
   â”‚  â”‚ origin/dest      â”‚        â”‚ origin_port          â”‚         â”‚
   â”‚  â”‚ etd, eta         â”‚        â”‚ etd, eta             â”‚         â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚              COMMUNICATION LAYER (RLS âŒ)                        â”‚
   â”‚                                                                  â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
   â”‚  â”‚   chat_messages      â”‚        â”‚   notifications        â”‚    â”‚
   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
   â”‚  â”‚ sender_id (FK)       â”‚        â”‚ audience_type          â”‚    â”‚
   â”‚  â”‚ receiver_id (FK)     â”‚        â”‚  ('role' / 'user')     â”‚    â”‚
   â”‚  â”‚ sender_role          â”‚        â”‚ audience_value         â”‚    â”‚
   â”‚  â”‚ receiver_role        â”‚        â”‚ user_id (FK)           â”‚    â”‚
   â”‚  â”‚ message              â”‚        â”‚ order_id               â”‚    â”‚
   â”‚  â”‚ file_url             â”‚        â”‚ title, description     â”‚    â”‚
   â”‚  â”‚ read (boolean)       â”‚        â”‚ severity               â”‚    â”‚
   â”‚  â”‚ deleted_by_*         â”‚        â”‚ unread (boolean)       â”‚    â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
   â”‚          â”‚                                 â”‚                    â”‚
   â”‚          â–¼                                 â–¼                    â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
   â”‚  â”‚chat_hidden_convs     â”‚        â”‚  notification_reads    â”‚    â”‚
   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
   â”‚  â”‚ user_id              â”‚        â”‚ notification_id        â”‚    â”‚
   â”‚  â”‚ hidden_user_id       â”‚        â”‚ user_id                â”‚    â”‚
   â”‚  â”‚ created_at           â”‚        â”‚ read_at                â”‚    â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
   â”‚                                                                  â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
   â”‚  â”‚ chat_typing_status   â”‚                                      â”‚
   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                      â”‚
   â”‚  â”‚ user_id              â”‚                                      â”‚
   â”‚  â”‚ typing_to_id         â”‚                                      â”‚
   â”‚  â”‚ is_typing (boolean)  â”‚                                      â”‚
   â”‚  â”‚ updated_at           â”‚                                      â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚              CONFIGURATION LAYER (RLS âœ…)                        â”‚
   â”‚                                                                  â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚                  business_config                          â”‚  â”‚
   â”‚  â”‚             (Solo 1 row, configuraciÃ³n global)            â”‚  â”‚
   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
   â”‚  â”‚ usd_rate, cny_rate, binance_rate, binance_rate_sell     â”‚  â”‚
   â”‚  â”‚ auto_update_* (boolean flags)                            â”‚  â”‚
   â”‚  â”‚ profit_margin                                             â”‚  â”‚
   â”‚  â”‚ air_shipping_rate, sea_shipping_rate                     â”‚  â”‚
   â”‚  â”‚ alerts_after_days                                         â”‚  â”‚
   â”‚  â”‚ admin_id (FK â†’ administrators)                            â”‚  â”‚
   â”‚  â”‚ updated_at                                                â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚                                                                  â”‚
   â”‚  RLS Policies:                                                  â”‚
   â”‚  âœ… Todos pueden VER (necesario para calculadoras)              â”‚
   â”‚  âœ… Solo Admins pueden EDITAR                                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚              EXCHANGE RATES LAYER (RLS âŒ)                       â”‚
   â”‚                                                                  â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚ exchange_rates   â”‚  â”‚exchange_rates_binanceâ”‚  â”‚exchange_ â”‚  â”‚
   â”‚  â”‚   (USD â†’ VES)    â”‚  â”‚   (USDT â†’ VES P2P)   â”‚  â”‚rates_cny â”‚  â”‚
   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚(USDâ†’CNY) â”‚  â”‚
   â”‚  â”‚ rate (numeric)   â”‚  â”‚ rate (numeric)       â”‚  â”‚          â”‚  â”‚
   â”‚  â”‚ source           â”‚  â”‚ trade_type           â”‚  â”‚          â”‚  â”‚
   â”‚  â”‚ timestamp        â”‚  â”‚  ('BUY' / 'SELL')    â”‚  â”‚          â”‚  â”‚
   â”‚  â”‚ is_fallback      â”‚  â”‚ source, timestamp    â”‚  â”‚          â”‚  â”‚
   â”‚  â”‚ api_response     â”‚  â”‚ is_fallback          â”‚  â”‚          â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ metadata (jsonb)     â”‚  â”‚          â”‚  â”‚
   â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚                                                                  â”‚
   â”‚  Funciones Helper:                                              â”‚
   â”‚  - get_latest_valid_exchange_rate_cny()                         â”‚
   â”‚  - get_latest_valid_binance_rate()                              â”‚
   â”‚  - get_binance_rate_history()                                   â”‚
   â”‚  - cleanup_old_* (maintenance)                                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Resumen de Seguridad RLS

| Tabla | RLS | Access Control |
|-------|-----|----------------|
| **userlevel** | âœ… | Users own, Admins all |
| **administrators** | âœ… | All authenticated read |
| **employees** | âœ… | All authenticated read |
| **clients** | âœ… | All authenticated read |
| **business_config** | âœ… | All read, Admin write |
| **order_reviews** | âœ… | Client own, Employee all |
| **product_alternatives** | âœ… | Complex policies |
| **orders** | âŒ | **CRÃTICO - SIN RLS** |
| **order_state_history** | âŒ | Expuesto |
| **payments** | âŒ | Expuesto |
| **chat_messages** | âŒ | Expuesto |
| **notifications** | âŒ | Expuesto |
| **containers/boxes** | âŒ | Expuesto |
| **exchange_rates_*** | âŒ | PÃºblica (OK) |

## ğŸ”„ Flujo de Estados de Pedido

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           ESTADOS NEGATIVOS (CancelaciÃ³n)       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–²
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        -2          â”‚  -1             â”‚
    RECHAZADO   CANCELADO             â”‚
        â–²           â–²                 â”‚
        â”‚           â”‚                 â”‚
        â”‚           â”‚                 â”‚ Cliente puede cancelar
        â”‚           â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚             ESTADOS POSITIVOS (Normal)          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    1           2           3              4
PEDIDO  â†’   RECIBIDO  â†’  COTIZADO  â†’  ESPERANDO PAGO
CREADO                                          â”‚
                                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
                5              6              7
           EN           PREPARANDO  â†’    LISTO PARA
        PROCESAMIENTO     ENVÃO           ENVÃO
                                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
                8           9           10
            ENVIADO  â†’  EN TRÃNSITO â†’ EN ADUANA
                                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
               11              12           13
           EN ALMACÃ‰N  â†’  LISTO PARA  â†’  ENTREGADO
           VENEZUELA      ENTREGA         âœ… FIN
```

## ğŸ’¾ Storage (Supabase Storage)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STORAGE BUCKETS                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  ğŸ“¦ avatars (public)                               â”‚
â”‚     â”œâ”€ {user_id}/{filename}                       â”‚
â”‚     â””â”€ RLS: Users can upload own avatar           â”‚
â”‚                                                    â”‚
â”‚  ğŸ“¦ orders (private)                               â”‚
â”‚     â”œâ”€ {order_id}/{filename}                      â”‚
â”‚     â””â”€ RLS: Users can access own order files      â”‚
â”‚                                                    â”‚
â”‚  ğŸ“¦ payments (private)                             â”‚
â”‚     â”œâ”€ {payment_id}/{filename}                    â”‚
â”‚     â””â”€ RLS: Restricted to Pagos role              â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ Tipos de Datos Custom (ENUMs)

```sql
-- Tipo de entrega
deliverytype: 'office' | 'warehouse' | 'express' | 'pickup' | 'delivery'

-- Tipo de envÃ­o
shippingType: 'maritime' | 'air' | 'doorToDoor'

-- PaÃ­s de origen (legacy, poco usado)
pais_tipo: 'vzla' | 'china'

-- Estados del pedido (legacy TEXT, no se usa actualmente)
order_state: Text ENUM (deprecated)
```

## ğŸ”— Conexiones CÃ³digo â†”ï¸ Base de Datos

### Client-Side (Browser)
```typescript
// lib/supabase/client.ts
// Usa: NEXT_PUBLIC_SUPABASE_ANON_KEY
// RLS: âœ… APLICADO
// Acceso: Limitado por polÃ­ticas RLS

const supabase = getSupabaseBrowserClient();
await supabase.from('orders').select('*');
// âŒ FALLA si orders no tiene RLS policies
```

### Server-Side (API Routes)
```typescript
// lib/supabase/server.ts
// Usa: SUPABASE_SERVICE_ROLE_KEY
// RLS: âŒ BYPASEADO
// Acceso: TOTAL (usar con cuidado)

const supabase = getSupabaseServiceRoleClient();
await supabase.from('orders').select('*');
// âœ… Funciona, devuelve TODO
```

### Security Definer Functions
```sql
-- Funciones que ejecutan con privilegios elevados
-- pero pueden ser llamadas por usuarios normales

CREATE FUNCTION get_my_orders(user_id uuid)
RETURNS TABLE(...) 
SECURITY DEFINER -- âš ï¸ Corre como postgres
AS $$
  -- ValidaciÃ³n interna aquÃ­
  SELECT * FROM orders WHERE client_id = user_id;
$$;
```

---

## ğŸ“š Referencias RÃ¡pidas

### Triggers Activos

| Tabla | Trigger | Tipo | FunciÃ³n |
|-------|---------|------|---------|
| orders | assign_order_on_insert | BEFORE INSERT | assign_order_to_employee() |
| orders | set_elapsed_time | BEFORE INSERT/UPDATE | set_elapsed_time() |
| orders | tr_order_state_change | AFTER INSERT/UPDATE | log_order_state_change() |
| userlevel | manage_user_roles | AFTER INSERT/UPDATE | manage_user_roles() |
| userlevel | update_employee_user_level | AFTER UPDATE | update_employee_user_level_function() |

### Foreign Keys CrÃ­ticas

```
clients.user_id â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ orders.client_id
employees.user_id â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ orders.asignedEChina
employees.user_id â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ orders.asignedEVzla
boxes.box_id â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ orders.box_id
```

---

**Nota:** Este diagrama representa el estado ACTUAL de la base de datos.  
Ver `ANALISIS_BASE_DE_DATOS.md` para el plan de mejora completo.
